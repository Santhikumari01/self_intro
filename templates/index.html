<!DOCTYPE html>
<html>
<head>
  <title>AI Self Introduction</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    pre { background:#f4f4f4; padding:10px; }
    button { padding:10px; margin:5px; }
  </style>
</head>
<body>

<h2>AI Interview â€“ Self Introduction</h2>

<button onclick="startAll()">Start Self Intro</button>
<button onclick="stopAll()">Stop</button>

<br><br>
<video id="video" width="400" autoplay muted></video>

<h3>ğŸ“· Video Output</h3>
<pre id="videoOut">Waiting...</pre>

<h3>ğŸ¤ Live Transcript</h3>
<pre id="liveText"></pre>

<h3>ğŸ§ Audio Analysis</h3>
<pre id="audioOut"></pre>

<h3>ğŸ† Final Score</h3>
<h2 id="finalScore">Waiting...</h2>

<script>
let video = document.getElementById("video");
let stream, mediaRecorder, audioChunks=[];
let videoTimer;

async function startAll(){
  await fetch("/start");

  stream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  video.srcObject = stream;

  mediaRecorder = new MediaRecorder(stream);
  mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
  mediaRecorder.start();

  videoTimer = setInterval(sendFrame, 2000);
}

async function stopAll(){
  clearInterval(videoTimer);

  stream.getTracks().forEach(t=>t.stop());
  mediaRecorder.stop();

  mediaRecorder.onstop = async ()=>{
    const blob = new Blob(audioChunks,{type:"audio/webm"});
    let fd = new FormData();
    fd.append("audio",blob);

    const res = await fetch("/analyze_audio",{method:"POST",body:fd});
    const audio = await res.json();

    document.getElementById("audioOut").innerText =
      JSON.stringify(audio,null,2);

    let videoScore = lastVideo.video_score || 0;
    let final = Math.round((videoScore + (audio.fluency_score||0))/2);
    document.getElementById("finalScore").innerText = final+"/100";
  };

  await fetch("/stop");
}

let lastVideo = {};
async function sendFrame(){
  let c=document.createElement("canvas");
  c.width=video.videoWidth;
  c.height=video.videoHeight;
  c.getContext("2d").drawImage(video,0,0);

  c.toBlob(async b=>{
    let fd=new FormData();
    fd.append("frame",b);
    const r=await fetch("/analyze_video",{method:"POST",body:fd});
    lastVideo=await r.json();
    document.getElementById("videoOut").innerText =
      JSON.stringify(lastVideo,null,2);
  });
}
</script>

</body>
</html>
